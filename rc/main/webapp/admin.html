<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Product Management</title>
  <link rel="stylesheet" href="../static/styles.css">
</head>
<body>
  <div class="container">
    <div id="userbar">
      <span id="userinfo"></span>
      <a href="index.html">Home</a>
      <button id="logoutBtn">Logout</button>
    </div>
    <h1>Product Management</h1>
    <div>
      <h2>Product List</h2>
      <div id="products" class="grid"></div>
    </div>
    <div>
      <h2>Add Product</h2>
      <form id="addForm">
        <label>Name</label>
        <input type="text" name="name" required>
        <label>Price</label>
        <input type="number" step="0.01" name="price" required>
        <label>Stock</label>
        <input type="number" name="stock" required>
        <button type="submit">Add</button>
      </form>
    </div>
   
    <div id="msg"></div>
  </div>
  <script>
    (function () {
      const hs = Array.from(document.querySelectorAll('h2'));
      hs.forEach(h => {
        const t = h.textContent.trim();
        if (t.indexOf('Edit Product') !== -1 || t.indexOf('Delete Product') !== -1) {
          const container = h.parentElement;
          if (container) container.remove();
        }
      });
    })();
    async function loadUser() {
      const res = await fetch('me');
      const data = await res.json();
      if (!data.loggedIn) {
        location.href = 'login.html';
        return;
      }
      document.getElementById('userinfo').textContent = `Welcome, ${data.username} (${data.role})`;
      if (data.role !== 'admin') {
        location.href = 'index.html';
        return;
      }
    }
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const res = await fetch('logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams()
      });
      const data = await res.json();
      if (data.success) location.href = 'login.html';
    });
    async function loadProducts() {
      const res = await fetch('admin/products');
      const list = await res.json();
      const div = document.getElementById('products');
      div.innerHTML = '';
      list.forEach(p => {
        const item = document.createElement('div');
        item.className = 'card';
        item.innerHTML = `
          <h3>${p.name}</h3>
          <p>ID：${p.id}</p>
          <p>Price: ¥${p.price}</p>
          <p>Stock: ${p.stock}</p>
          <div class="actions">
            <button class="btn-update" data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-stock="${p.stock}">Edit</button>
            <button class="btn-delete" data-id="${p.id}">Delete</button>
          </div>
        `;
        div.appendChild(item);
      });
    }
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const params = new URLSearchParams();
      params.append('name', form.name.value);
      params.append('price', form.price.value);
      params.append('stock', form.stock.value);
      const res = await fetch('admin/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('msg').textContent = 'Added successfully';
        loadProducts();
      } else {
        document.getElementById('msg').textContent = 'Add failed';
      }
    });
    
    document.getElementById('products').addEventListener('click', async (e) => {
      const t = e.target;
      if (t.classList.contains('btn-update')) {
        const id = t.dataset.id;
        const name = prompt('Name', t.dataset.name);
        if (name === null) return;
        const price = prompt('Price', t.dataset.price);
        if (price === null) return;
        const stock = prompt('Stock', t.dataset.stock);
        if (stock === null) return;
        const params = new URLSearchParams();
        params.append('productId', id);
        params.append('name', name);
        params.append('price', price);
        params.append('stock', stock);
        const res = await fetch('admin/product/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params
        });
        const data = await res.json();
        document.getElementById('msg').textContent = data.success ? 'Updated successfully' : 'Update failed';
        if (data.success) loadProducts();
      }
      if (t.classList.contains('btn-delete')) {
        const id = t.dataset.id;
        if (!confirm('Confirm delete product ID ' + id + ' ?')) return;
        const params = new URLSearchParams();
        params.append('productId', id);
        const res = await fetch('admin/product/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params
        });
        const data = await res.json();
        document.getElementById('msg').textContent = data.success ? 'Deleted successfully' : 'Delete failed';
        if (data.success) loadProducts();
      }
    });
    loadUser().then(loadProducts);
  </script>
</body>
</html>




